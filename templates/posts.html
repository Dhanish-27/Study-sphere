{% extends 'base_new.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8" style="border: 2px solid black;">
    <h1 class="text-3xl font-bold mb-6">All Posts</h1>
    <div id="posts-container" class="grid grid-cols-1 gap-6">
        {% for post in posts %}
        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            {% if post.image %}
                <img src="{{ post.image.url }}" alt="Post image" class="w-full h-64 object-cover" style="aspect-ratio: 1/1;">
            {% else %}
                <div class="w-full h-64 bg-gray-200 flex items-center justify-center">
                    <span class="text-gray-500">No Image</span>
                </div>
            {% endif %}
            <div class="p-4">
                <h2 class="text-xl font-semibold mb-2">{{ post.title }}</h2>
                <p class="text-gray-700 mb-3 description" data-full-text="{{ post.description }}">{{ post.description|truncatechars:100 }}</p>
                {% if post.description|length > 100 %}
                    <button class="text-blue-500 hover:text-blue-700 read-more-btn">Read more</button>
                {% endif %}
                <div class="flex items-center text-sm text-gray-500 mt-2">
                    <span>By {{ post.user.username }}</span>
                    <span class="mx-2">•</span>
                    <span>{{ post.created_at|date:"M d, Y H:i" }}</span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% if posts.has_next %}
        <div id="loading" class="text-center py-4 hidden">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900"></div>
            <span class="ml-2">Loading more posts...</span>
        </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let page = 1;
    let loading = false;
    const postsContainer = document.getElementById('posts-container');
    const loadingDiv = document.getElementById('loading');

    function setupReadMore() {
        document.querySelectorAll('.read-more-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const p = this.previousElementSibling;
                const fullText = p.getAttribute('data-full-text');
                if (this.textContent === 'Read more') {
                    p.textContent = fullText;
                    this.textContent = 'Read less';
                } else {
                    p.textContent = fullText.substring(0, 100) + '...';
                    this.textContent = 'Read more';
                }
            });
        });
    }

    setupReadMore(); // Setup for initial posts

    function loadMorePosts() {
        if (loading) return;
        loading = true;
        loadingDiv.classList.remove('hidden');
        page++;

        fetch(`?page=${page}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            data.posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.className = 'bg-white rounded-lg shadow-md overflow-hidden';
                postElement.innerHTML = `
                    ${post.image ? `<img src="${post.image}" alt="Post image" class="w-full h-64 object-cover">` : '<div class="w-full h-64 bg-gray-200 flex items-center justify-center"><span class="text-gray-500">No Image</span></div>'}
                    <div class="p-4">
                        <h2 class="text-xl font-semibold mb-2">${post.title}</h2>
                        <p class="text-gray-700 mb-3 description" data-full-text="${post.description.replace(/"/g, '"')}">${post.description.length > 100 ? post.description.substring(0, 100) + '...' : post.description}</p>
                        ${post.description.length > 100 ? '<button class="text-blue-500 hover:text-blue-700 read-more-btn">Read more</button>' : ''}
                        <div class="flex items-center text-sm text-gray-500 mt-2">
                            <span>By ${post.user}</span>
                            <span class="mx-2">•</span>
                            <span>${new Date(post.created_at).toLocaleString()}</span>
                        </div>
                    </div>
                `;
                postsContainer.appendChild(postElement);
            });

            setupReadMore(); // Setup for new posts

            if (!data.has_next) {
                loadingDiv.style.display = 'none';
            }
            loading = false;
            loadingDiv.classList.add('hidden');
        })
        .catch(error => {
            console.error('Error loading more posts:', error);
            loading = false;
            loadingDiv.classList.add('hidden');
        });
    }

    function checkScroll() {
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        const windowHeight = window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const scrollPercentage = (scrollTop + windowHeight) / documentHeight;

        if (scrollPercentage > 0.75) {
            loadMorePosts();
        }
    }

    window.addEventListener('scroll', checkScroll);
});
</script>
{% endblock %}
